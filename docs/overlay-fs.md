# AgentFS CoW ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤

## æ¦‚è¦

zi ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒªã‚¢ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ç›´æ¥æ›¸ãè¾¼ã¾ãšã€Copy-on-Write (CoW) ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é€šã˜ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ“ä½œã™ã‚‹ã€‚èª­ã¿å–ã‚Šã¯å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã€æ›¸ãè¾¼ã¿ã¯ SQLite ãƒ™ãƒ¼ã‚¹ã® delta ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã®ã¿ä¿å­˜ã•ã‚Œã‚‹ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merged View (ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¦‹ã‚‹)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Delta Layer (AgentFS SQLite DB)   â”‚  â† æ›¸ãè¾¼ã¿ã¯ã“ã“
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Base Layer (å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª cwd)     â”‚  â† èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | å½¹å‰² |
|---------|-----------|------|
| Delta | `.zi/sessions/<id>.db` (SQLite) | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ›¸ãè¾¼ã¿ã‚’å…¨ã¦ä¿æŒ |
| Base | `process.cwd()` ã®å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | èª­ã¿å–ã‚Šå°‚ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ƒ |

### æ“ä½œã”ã¨ã®æŒ¯ã‚‹èˆã„

| æ“ä½œ | æ–¹é‡ |
|------|------|
| `readFile` | delta ã‚’å…ˆã«ç¢ºèª â†’ ãªã‘ã‚Œã° baseï¼ˆå®ŸFSï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| `stat` / `lstat` | delta â†’ base ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| `readdir` | delta + base ã‚’ãƒãƒ¼ã‚¸ï¼ˆSet ã§é‡è¤‡æ’é™¤ï¼‰ |
| `readdirPlus` | delta + base ã‚’ãƒãƒ¼ã‚¸ï¼ˆstat ä»˜ãï¼‰ |
| `access` | delta â†’ base ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| `readlink` | delta â†’ base ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| `writeFile` | delta ã®ã¿ã«æ›¸ã |
| `mkdir` | delta ã®ã¿ |
| `unlink` / `rmdir` / `rm` | delta ã®ã¿ |
| `rename` | base ã«ã—ã‹ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ CoW ã‚³ãƒ”ãƒ¼å¾Œã« delta å†…ã§ rename |
| `copyFile` | src ã‚’èª­ã‚“ã§ï¼ˆdelta â†’ baseï¼‰dest ã‚’ delta ã«æ›¸ã |
| `symlink` | delta ã®ã¿ |
| `open` | delta â†’ base ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆCoW ã‚³ãƒ”ãƒ¼ï¼‰ |
| `statfs` | delta ã«å§”è­² |

## ãƒ‘ã‚¹æ­£è¦åŒ–

OverlayAgentFS ã¯ã™ã¹ã¦ã®ãƒ‘ã‚¹ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«æ­£è¦åŒ–ã—ã¦ã‹ã‚‰å‡¦ç†ã™ã‚‹ã€‚

```
toAbsolute("src/index.ts")
  â†’ resolve(baseDir, "src/index.ts")
  â†’ /Users/user/project/src/index.ts

toAbsolute("/Users/user/project/src/index.ts")
  â†’ resolve("/Users/user/project/src/index.ts")
  â†’ /Users/user/project/src/index.ts
```

ã“ã‚Œã«ã‚ˆã‚Šã€ç›¸å¯¾ãƒ‘ã‚¹ã¨çµ¶å¯¾ãƒ‘ã‚¹ãŒæ··åœ¨ã—ã¦ã‚‚ delta ã®ä¸€è²«æ€§ãŒä¿ãŸã‚Œã‚‹ã€‚

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
src/
â”œâ”€â”€ fs/
â”‚   â””â”€â”€ overlay-agentfs.ts   # OverlayAgentFS (FileSystem interface å®Ÿè£…)
â”œâ”€â”€ agent/
â”‚   â””â”€â”€ session.ts           # Session ç”Ÿæˆæ™‚ã« OverlayAgentFS ã‚’æ§‹ç¯‰
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ read.ts              # fs.readFile() â†’ overlay çµŒç”±
â”‚   â”œâ”€â”€ write.ts             # fs.writeFile() â†’ delta ã«æ›¸ã
â”‚   â”œâ”€â”€ edit.ts              # fs.readFile() + fs.writeFile() â†’ overlay çµŒç”±
â”‚   â””â”€â”€ bash.ts              # just-bash ã® OverlayFs ã§ç‹¬ç«‹ã—ãŸ CoW
â””â”€â”€ index.ts                 # Bash ã« just-bash OverlayFs ã‚’æ¥ç¶š
```

### read/write/edit ãƒ„ãƒ¼ãƒ«ã¨ bash ãƒ„ãƒ¼ãƒ«ã®é•ã„

| | read / write / edit | bash |
|---|---|---|
| FS å®Ÿè£… | `OverlayAgentFS` (agentfs-sdk `FileSystem`) | just-bash `OverlayFs` (`IFileSystem`) |
| Delta ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | AgentFS SQLite DB | ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª |
| æ°¸ç¶šåŒ– | ã‚»ãƒƒã‚·ãƒ§ãƒ³ DB ã«ä¿å­˜ã•ã‚Œã‚‹ | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã§æ¶ˆãˆã‚‹ |
| Base | å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | å®Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª |

bash ã¨ read/write/edit ã¯åˆ¥ã€…ã® delta ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒã¤ã€‚bash ã§æ›¸ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ read ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã¯è¦‹ãˆãšã€write ãƒ„ãƒ¼ãƒ«ã§æ›¸ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ bash ã® `cat` ã‹ã‚‰ã¯è¦‹ãˆãªã„ã€‚ã“ã‚Œã¯æ—¢çŸ¥ã®åˆ¶é™ã§ã‚ã‚Šã€å°†æ¥çš„ã«çµ±åˆå¯èƒ½ã€‚

## å¤‰æ›´ã®è¿½è·¡ã¨é©ç”¨

### å¤‰æ›´è¿½è·¡

`OverlayAgentFS` ã¯ `writeFile`ã€`rename`ã€`copyFile` ã‚’å‘¼ã³å‡ºã™ãŸã³ã«ã€å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ `modifiedFiles: Set<string>` ã«è¨˜éŒ²ã™ã‚‹ã€‚

### ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆæ°¸ç¶šåŒ–

ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã« `persistManifest()` ãŒå‘¼ã°ã‚Œã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ delta å†…ã® `/__zi_manifest.json` ã«ä¿å­˜ã™ã‚‹ã€‚

```json
["/Users/user/project/README.md", "/Users/user/project/src/new-file.ts"]
```

### é©ç”¨ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TUI çµ‚äº†     â”‚ â”€â”€â†’ â”‚ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ   â”‚ â”€â”€â†’ â”‚ ã‚µãƒãƒªãƒ¼è¡¨ç¤º  â”‚
â”‚ (Ctrl-D)    â”‚     â”‚ æ°¸ç¶šåŒ–        â”‚     â”‚ + ã‚³ãƒãƒ³ãƒ‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â” Session ended â”â”â”
ğŸ“ 2 file(s) modified:

  M README.md
  A src/new-file.ts

To review and apply:
  zi apply abc123
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ zi apply    â”‚ â”€â”€â†’ â”‚ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ   â”‚ â”€â”€â†’ â”‚ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§  â”‚ â”€â”€â†’ â”‚ å®Ÿ FS ã«    â”‚
â”‚ <session-id>â”‚     â”‚ èª­ã¿è¾¼ã¿      â”‚     â”‚ + ç¢ºèª       â”‚     â”‚ æ›¸ãå‡ºã—    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

$ zi apply abc123

Applying session abc123...

  M README.md (1234 bytes)
  A src/new-file.ts (456 bytes)

Apply these changes? [Y/n] y

âœ“ Applied 2 file(s)
```

### `zi apply` ã®å†…éƒ¨å‡¦ç†

1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ DB (`.zi/sessions/<id>.db`) ã‚’é–‹ã
2. `/__zi_manifest.json` ã‹ã‚‰å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ delta ã®å†…å®¹ã‚’èª­ã¿å‡ºã™
4. æ–°è¦ (A) / ä¿®æ­£ (M) ã‚’åˆ¤å®šã—ã¦ä¸€è¦§è¡¨ç¤º
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
6. `node:fs/promises.writeFile()` ã§å®Ÿ FS ã«æ›¸ãå‡ºã™

## å‹ã®é–¢ä¿‚

```
agentfs-sdk
â”œâ”€â”€ FileSystem (interface)     â† OverlayAgentFS ãŒå®Ÿè£…
â”‚   â”œâ”€â”€ readFile, writeFile, stat, readdir, ...
â”‚   â””â”€â”€ open, statfs, readdirPlus, ...
â””â”€â”€ AgentFS (class)            â† FileSystem ã‚’ implements
    â””â”€â”€ SQLite ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

just-bash
â”œâ”€â”€ IFileSystem (interface)    â† OverlayFs ãŒå®Ÿè£…
â”‚   â”œâ”€â”€ readFile, writeFile, stat, readdir, ...
â”‚   â””â”€â”€ exists, cp, mv, chmod, realpath, ...
â””â”€â”€ OverlayFs (class)          â† IFileSystem ã‚’ implements
    â””â”€â”€ å®Ÿ FS + ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª CoW
```

ãƒ„ãƒ¼ãƒ«ï¼ˆread/write/editï¼‰ã¯ `FileSystem` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å—ã‘å–ã‚‹ãŸã‚ã€`OverlayAgentFS` ã§ã‚‚ `AgentFS` ã§ã‚‚å‹•ä½œã™ã‚‹ã€‚

## å°†æ¥ã®æ‹¡å¼µ

- **Whiteout ãƒãƒ¼ã‚«ãƒ¼**: delta ã§ã®å‰Šé™¤ã‚’ base ã«å¯¾ã—ã¦ã‚‚åæ˜ ã™ã‚‹ä»•çµ„ã¿
- **bash çµ±åˆ**: `FileSystem` â†’ `IFileSystem` ã‚¢ãƒ€ãƒ—ã‚¿ã§ bash ã¨ read/write/edit ã® delta ã‚’çµ±åˆ
- **Write-through ãƒ¢ãƒ¼ãƒ‰**: delta ã¨å®Ÿ FS ã«åŒæ™‚æ›¸ãè¾¼ã¿ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- **å·®åˆ†è¡¨ç¤º**: `zi apply` ã§ unified diff ã‚’è¡¨ç¤º
